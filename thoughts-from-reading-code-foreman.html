<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://blog.jimjh.com/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://blog.jimjh.com/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://blog.jimjh.com/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="James Lim">
  <meta name="description" content="Posts and writings by James Lim">

  <link href="http://feeds.feedburner.com/jimjh/blog" type="application/rss+xml" rel="alternate" title="Ampersand RSS" />

<meta name="keywords" content="ruby, reading">

  <title>
    Ampersand
&ndash; Thoughts from Reading Code - Foreman  </title>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5604647-6']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="https://blog.jimjh.com">
        <img src="https://blog.jimjh.com/images/jimjh.png" alt="logo">
      </a>
      <h2><a href="https://blog.jimjh.com">James Lim</a></h2>
      <p></p>
      <ul>
        <li><a href="https://jimjh.com" target="_blank">Profile</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://blog.jimjh.com">Index</a> &brvbar; <a href="https://blog.jimjh.com/archives.html">Archives</a>
      &brvbar; <a href="http://feeds.feedburner.com/jimjh/blog">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://blog.jimjh.com/thoughts-from-reading-code-foreman.html">Thoughts from Reading Code - Foreman</a></h1>
  </div>
  <div class="article_text">
    <p>I read a lot of open source code in my free time to make myself a better engineer. Here are some of my notes from reading foreman's <a href="https://github.com/ddollar/foreman/blob/master/lib/foreman/cli.rb">cli.rb</a>.</p>
<h3>Code Style - Raising Exceptions with a Bang</h3>
<p>You might occasionally encounter code that looks like this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">process</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
  <span class="k">raise</span> <span class="no">MyException</span><span class="p">,</span> <span class="s1">&#39;oops&#39;</span> <span class="k">unless</span> <span class="n">some_condition</span>
  <span class="k">if</span> <span class="n">some_other_condition</span>
    <span class="nb">puts</span> <span class="s2">&quot;meaningful error message&quot;</span>
    <span class="k">raise</span> <span class="no">AnotherException</span><span class="p">,</span> <span class="s1">&#39;oops&#39;</span>
  <span class="k">end</span>
  <span class="n">do_something_useful</span>
  <span class="n">do_some_other_useful_thing</span>
<span class="k">end</span>
</pre></div>


<p>This seems perfectly normal - <code>start</code> validates a few conditions (possibly derived from the context or environment), and decides if it is OK to continue with the operation. However, such validations get in the way of readability, and are often duplicated in other methods. To keep things SOLID and DRY, let's extract these out into private methods.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">process</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
  <span class="n">check_some_condition</span>
  <span class="n">check_some_other_condition</span>
  <span class="n">do_something_useful</span>
  <span class="n">do_some_other_useful_thing</span>
<span class="k">end</span>
</pre></div>


<p>Much better. The code is a lot easier to read, but the helper methods have masked their side effects. (In this case, exceptions are raised and output is printed when some conditions are not met.) This can be confusing as the code base grows and becomes more complicated. A new team member would take a longer time to go through the code and learn that the <code>check_*</code> methods have potential side effects. To fix this, let's add a <code>!</code> to the end of their names.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">process</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
  <span class="n">check_some_condition!</span>
  <span class="n">check_some_other_condition!</span>
  <span class="n">do_something_useful</span>
  <span class="n">do_some_other_useful_thing</span>
<span class="k">end</span>
</pre></div>


<p>With this edit, the <code>start</code> method's purpose and operations become immediately apparent.</p>
<h3>Technique - Loading Configuration Files</h3>
<p>Using Thor, one can easily create a command-line interface by defining options for tasks and accessing arguments via the <code>options</code> hash. For example,</p>
<div class="highlight"><pre><span></span><span class="n">method_option</span> <span class="ss">:color</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:boolean</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">()</span>
  <span class="c1"># â€¦</span>
<span class="k">end</span>
</pre></div>


<p>adds a <code>start</code> task that accepts a <code>--color</code> option. It is often useful to allow the user to specify frequently used configuration options with a configuration file, such as <code>.rspec</code> and <code>.yardopts</code>. With Thor, the <code>options</code> getter method provides a convenient place to merge options from the configuration file and from the command-line.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">options</span>
  <span class="n">original</span> <span class="o">=</span> <span class="k">super</span>                                 <span class="c1"># get original options hash</span>
  <span class="k">return</span> <span class="n">original</span> <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span> <span class="no">CONFIG_FILE</span>
  <span class="n">defaults</span> <span class="o">=</span> <span class="o">::</span><span class="no">YAML</span><span class="o">::</span><span class="n">load_file</span><span class="p">(</span><span class="no">CONFIG_FILE</span><span class="p">)</span> <span class="o">||</span> <span class="p">{}</span>  <span class="c1"># read from config file</span>
  <span class="n">defaults</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>                         <span class="c1"># merge</span>
<span class="k">end</span>
</pre></div>


<p>Note that options provided on the command-line override the options given in the configuration file.</p>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 30 July 2013</p>
    <p>Category: <a href="https://blog.jimjh.com/category/software.html">Software</a>
 &ndash; Tags:
      <a href="https://blog.jimjh.com/tag/ruby.html">ruby</a>,      <a href="https://blog.jimjh.com/tag/reading.html">reading</a>    </p>
  </div>

  <div id="article_comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_identifier = "thoughts-from-reading-code-foreman.html";
        (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = '//jimjh.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
    </script>
  </div>

</article>


    <div id="ending_message">
      <p>&copy; James Lim. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>