<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://blog.jimjh.com/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://blog.jimjh.com/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://blog.jimjh.com/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="James Lim">
  <meta name="description" content="Posts and writings by James Lim">

  <link href="http://feeds.feedburner.com/jimjh/blog" type="application/rss+xml" rel="alternate" title="Ampersand RSS" />

<meta name="keywords" content="ruby, stripe">

  <title>
    Ampersand
&ndash; Stripe CTF 2014, Level 0  </title>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5604647-6']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="https://blog.jimjh.com">
        <img src="https://blog.jimjh.com/images/jimjh.png" alt="logo">
      </a>
      <h2><a href="https://blog.jimjh.com">James Lim</a></h2>
      <p></p>
      <ul>
        <li><a href="https://jimjh.com" target="_blank">Profile</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://blog.jimjh.com">Index</a> &brvbar; <a href="https://blog.jimjh.com/archives.html">Archives</a>
      &brvbar; <a href="http://feeds.feedburner.com/jimjh/blog">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://blog.jimjh.com/stripe-ctf-2014-level-0.html">Stripe CTF 2014, Level 0</a></h1>
  </div>
  <div class="article_text">
    <p>I participated in a week-long CTF hosted by Stripe in Jan 2014. This series of blog posts will cover some of the problems and their solutions.</p>
<h3>Level 0</h3>
<p>The first level was a breeze, and mainly served as an introduction/tutorial
for participating in the CTF. We were given the following code, and asked to
improve its running time:</p>
<script src="https://gist.github.com/jimjh/9178255.js"></script>

<p>This looks like a simple spellchecker. Given an input of size <em>m</em> and a
dictionary of size <em>n</em>, the above implementation has a running time of O(<em>mn</em>).
The easiest way to get past this level is to use a hash set, instead of an
array, to hold the dictionary. This reduces the running time to O(<em>m</em>).</p>
<p>Next, I tried rewriting the code in Java, and tuning the JVM to squeeze more
performance out of it. I eventually settled on the following flags, which
brought the running time from ~0.3 seconds to ~0.2 seconds.</p>
<script src="https://gist.github.com/jimjh/9178295.js"></script>

<p>Most of the gains came from setting the initial heap size with <code>Xms</code> (to avoid
increasing the heap size at runtime) and setting the initial capacity for the
hashmap to some reasonably large number (to avoid expanding and copying the
set's contents at runtime.) The latter worked because the same dictionary was
used every time, and we knew the exact number of elements that would be added to
the set.</p>
<p>To get on the leader board, we needed to put in more work. It quickly became
clear (through profiling) that most of the time was spent reading and
initializing the dictionary. This can be dramatically reduced by pre-processing
the hash set and then using mmap to load it into memory. (You could also get
fancier and use <code>objcopy</code> to create a compiled object that could be linked into
the executable.) For this, I implemented <a href="https://github.com/jimjh/stripe-level0">my own hashset</a> that uses
contiguous memory and can be loaded using mmap.</p>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ruby Array</td>
<td>7.15 s</td>
</tr>
<tr>
<td>Ruby Hash Map</td>
<td>0.386 s</td>
</tr>
<tr>
<td>Java with Flags</td>
<td>0.253 s</td>
</tr>
<tr>
<td>C with mmap</td>
<td>0.008 s</td>
</tr>
</tbody>
</table>
<p>Other things I tried but didn't work:</p>
<ul>
<li>serializing the set beforehand and deserializing it (using <code>Marshal#load</code>, or
Java's equivalent) at runtime</li>
<li>using nio's <code>MappedByteBuffer</code> to load the hash set (didn't expect this to
make a huge difference anyway, since I still had to copy the bytes into user
space to re-construct the set.)</li>
</ul>
<p>I also tried using gperf to try finding a reasonable perfect hash function for
the dictionary, but it took too many hours to generate and compile, and I gave
up. At this point I decided to move on to the next level.  However, here are
some ideas that might have worked:</p>
<ul>
<li>implementing a bloom filter in C, then using mmap to load the filter at runtime</li>
</ul>
<p>Note that using a bloom filter is probabilistic - it could get you on the
leader board if you pushed enough times.</p>
<p>I uploaded <a href="https://github.com/jimjh/stripe-level0">some of my work</a> to GitHub. Take a shot.</p>
  </div>
  <div class="article_meta">
    <p>Posted on: Sun 23 February 2014</p>
    <p>Category: <a href="https://blog.jimjh.com/category/software.html">Software</a>
 &ndash; Tags:
      <a href="https://blog.jimjh.com/tag/ruby.html">ruby</a>,      <a href="https://blog.jimjh.com/tag/stripe.html">stripe</a>    </p>
  </div>

  <div id="article_comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_identifier = "stripe-ctf-2014-level-0.html";
        (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = '//jimjh.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
    </script>
  </div>

</article>


    <div id="ending_message">
      <p>&copy; James Lim. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>